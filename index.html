<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  <title>물 마시기 인증</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <style>
    body,
    html {
      height: 100%;
      margin: 0;
    }

    .container {
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
    }

    .btn {
      max-height: 75%;
    }

    #image-preview {
      display: none;
      max-width: 100%;
      height: 0%;
    }

    .hidden {
      display: none;
    }

    .certified-message {
      color: red;
      font-size: 1.5em;
    }

    .failure-message {
      color: red;
      margin-top: 10px;
    }

    .btn:active,
    .btn:hover {
      border: none !important;
    }
  </style>
</head>

<body onload="init()">
  <div class="container">
    <h1 class="fixed-top" id="title"></h1>

    <input type="file" id="fileInput" class="d-none">
    <div id="auth-container">

      <div id="loding" class="spinner-border" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p id="certified-message" class="certified-message hidden">인증되었습니다</p>
      <button type="button" id="auth-button" class="btn hidden" onclick="selectImage()">
        <p class="auth_text">이미지 선택하기</p>
        <img id="image-preview" src="#" alt="Image Preview" style="max-height: 400px;" class="mb-5 img-fulid">

      </button>
      <p id="failure-message" class="failure-message hidden">인증에 실패하였습니다.<br>이미지를 눌러 다시 인증하세요.</p>
    </div>
    <div id="label-container" class="mt-3 d-none"></div>
    <div id="authenticate-status" class="py-4 fixed-bottom btn btn-warning">미인증</div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
    integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"
    integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy"
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
  <script type="text/javascript">
    const urlParams = new URLSearchParams(window.location.search);
    const isAuth = urlParams.get('isAuth');
    const modelType = urlParams.get('modelType')
    const modelTitle = urlParams.get('modelTitle')
    let userAuth = isAuth === null || isAuth === "false" ? false : true;
    const URL = modelType === null ? "./morning/" : `./${modelType}/`;
    let model, labelContainer, maxPredictions;
    let predictionResult;


    async function init() {
      const modelURL = URL + "model.json";
      const metadataURL = URL + "metadata.json";
      model = await tmImage.load(modelURL, metadataURL);
      maxPredictions = model.getTotalClasses();
      labelContainer = document.getElementById("label-container");
      for (let i = 0; i < maxPredictions; i++) {
        labelContainer.appendChild(document.createElement("div"));
      }
      modelTitle !== null ? title.textContent = modelTitle : 0
      checkUserAuth();
    }

    function checkUserAuth() {
      const authButton = document.getElementById('auth-button');
      const certifiedMessage = document.getElementById('certified-message');
      const authenticateStatus = document.getElementById('authenticate-status');
      const failureMessage = document.getElementById('failure-message');

      if (userAuth) {
        authButton.classList.add('hidden');
        certifiedMessage.classList.remove('hidden');
        authenticateStatus.textContent = '인증완료';
        loding.classList.add('hidden');
        failureMessage.classList.add('hidden');
      } else {
        authButton.classList.remove('hidden');
        certifiedMessage.classList.add('hidden');
        loding.classList.add('hidden');
        authenticateStatus.textContent = '미인증';
      }
    }

    function selectImage() {
      document.getElementById('fileInput').click();
    }

    document.getElementById('fileInput').addEventListener('change', handleImageUpload);

    async function handleImageUpload(event) {
      const file = event.target.files[0];
      const reader = new FileReader();
      reader.onload = async function (event) {
        const image = new Image();
        image.src = event.target.result;
        image.onload = async function () {
          document.getElementById('image-preview').style.display = 'block';
          document.getElementById('image-preview').src = image.src;
          document.querySelector('.auth_text').classList.add('d-none');
          await predict(image);
        };
      };
      reader.readAsDataURL(file);
    }

    async function predict(image) {
      const prediction = await model.predict(image);
      predictionResult = prediction[0].probability.toFixed(2) >= 0.5;
      for (let i = 0; i < maxPredictions; i++) {
        const classPrediction =
          prediction[i].className + ": " + prediction[i].probability.toFixed(2);
        labelContainer.childNodes[i].innerHTML = classPrediction;
      }
      updateAuthenticateStatus();
    }

    function updateAuthenticateStatus() {
      const authenticateStatus = document.getElementById('authenticate-status');
      const failureMessage = document.getElementById('failure-message');
      if (predictionResult) {
        // authenticateStatus.textContent = '인증완료';
        // userAuth = true;
        // checkUserAuth();
        sendMessageToExpo({authenticated: true});
      } else {
        // authenticateStatus.textContent = '미인증';
        // failureMessage.classList.remove('hidden');
        sendMessageToExpo({authenticated: false});
      }
    }

    function sendMessageToExpo(message) {
      if (window.ReactNativeWebView && window.ReactNativeWebView.postMessage) {
        window.ReactNativeWebView.postMessage(JSON.stringify(message));
      }
    }

  </script>
</body>

</html>